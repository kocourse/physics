<!DOCTYPE html>
<html>
<head>
    <title>互動式三電荷電力線</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: sans-serif; }
        .ui { position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="ui">
        <b>互動電力線模擬</b><br>
        拖曳電荷移動位置<br>
        紅：正電荷 | 藍：負電荷
    </div>

<script>
let charges = [];
const linesPerCharge = 16; // 每單位電量的場線數量

function setup() {
    createCanvas(windowWidth, windowHeight);
    // 初始化：正電荷 +1 (發射 16 條), 負電荷 -1 (接收 16 條), 正電荷 +1 (發射 16 條)
    charges.push(new Charge(width/2 - 200, height/2, 1));
    charges.push(new Charge(width/2 + 200, height/2, -1));
    charges.push(new Charge(width/2, height/2 - 150, 1));
}

function draw() {
    background(0);
    
    // 只從「正電荷」出發畫線 (場線由正極流向負極或無限遠)
    for (let c of charges) {
        if (c.q > 0) {
            let numLines = Math.abs(c.q) * linesPerCharge;
            for (let a = 0; a < TWO_PI; a += TWO_PI / numLines) {
                // 從電荷邊緣一點點的位置出發
                let startX = c.x + cos(a) * 15;
                let startY = c.y + sin(a) * 15;
                traceFieldLine(startX, startY);
            }
        }
    }

    for (let c of charges) {
        c.update();
        c.display();
    }
}

function traceFieldLine(x, y) {
    let px = x;
    let py = y;
    let stepSize = 6;
    let maxSteps = 150; // 增加步數讓線條延伸更遠
    
    noFill();
    stroke(255, 255, 255, 100);
    beginShape();
    
    let lastAngle = 0;
    for (let k = 0; k < maxSteps; k++) {
        let totalE = createVector(0, 0);
        let nearCharge = false;

        for (let c of charges) {
            let r = createVector(px - c.x, py - c.y);
            let d = r.mag();
            
            // 如果撞到負電荷或回到原電荷，就停止
            if (d < 10) { nearCharge = true; break; }
            
            r.normalize().mult(c.q / (d * d));
            totalE.add(r);
        }

        if (nearCharge) break;

        lastAngle = totalE.heading();
        vertex(px, py);
        
        totalE.normalize().mult(stepSize);
        px += totalE.x;
        py += totalE.y;

        // 離開畫面也停止
        if (px < 0 || px > width || py < 0 || py > height) break;
    }
    endShape();

    // 在電力線的末端畫箭頭
    drawArrowHead(px, py, lastAngle);
}

function drawArrowHead(x, y, angle) {
    push();
    translate(x, y);
    rotate(angle);
    fill(255, 200);
    noStroke();
    triangle(8, 0, -5, -4, -5, 4);
    pop();
}
</script>
</body>
</html>
