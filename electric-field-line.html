<!DOCTYPE html>
<html>
<head>
    <title>互動式三電荷電力線</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: sans-serif; }
        .ui { position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="ui">
        <b>互動電力線模擬</b><br>
        拖曳電荷移動位置<br>
        紅：正電荷 | 藍：負電荷
    </div>

<script>
let charges = [];

function setup() {
    createCanvas(windowWidth, windowHeight);
    // 初始化三個電荷：x, y, 電量q
    charges.push(new Charge(width/2 - 100, height/2, 1));
    charges.push(new Charge(width/2 + 100, height/2, -1));
    charges.push(new Charge(width/2, height/2 - 100, 1));
}

function draw() {
    background(0);
    
    // 繪製電力線 (簡化版：從畫面各處出發)
    stroke(255, 255, 255, 50);
    for (let i = 0; i < width; i += 40) {
        for (let j = 0; j < height; j += 40) {
            drawFieldLine(i, j);
        }
    }

    // 繪製並更新電荷
    for (let c of charges) {
        c.display();
        if (mouseIsPressed && dist(mouseX, mouseY, c.x, c.y) < 20) {
            c.x = mouseX;
            c.y = mouseY;
        }
    }
}

function drawFieldLine(x, y) {
    let px = x;
    let py = y;
    let steps = 15; // 增加線段長度
    let arrowGap = 8; // 每隔幾步畫一個箭頭

    beginShape();
    noFill();
    stroke(255, 255, 255, 80);

    for (let k = 0; k < steps; k++) {
        let field = createVector(0, 0);
        
        // 計算該點受所有電荷影響的總電場
        for (let c of charges) {
            let v = createVector(px - c.x, py - c.y);
            let d = v.mag();
            if (d < 15) return; // 靠電荷太近就停止繪製
            v.normalize();
            // 電場強度與距離平方成反比 E = k*q/r^2
            v.mult(c.q / (d * d));
            field.add(v);
        }

        field.normalize();
        
        // 在特定步數繪製箭頭
        if (k === arrowGap) {
            drawArrow(px, py, field.heading());
        }

        let stepSize = 10; 
        px += field.x * stepSize;
        py += field.y * stepSize;
        vertex(px, py);
    }
    endShape();
}

// 專門繪製箭頭的輔助函數
function drawArrow(x, y, angle) {
    push();
    translate(x, y);
    rotate(angle);
    fill(255, 255, 255, 150);
    noStroke();
    let arrowSize = 6;
    // 畫一個指向正前方的三角形
    triangle(arrowSize, 0, -arrowSize, -arrowSize/1.5, -arrowSize, arrowSize/1.5);
    pop();
}
</script>
</body>

</html>
